<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç©ºãæ™‚é–“ - ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .search-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 5px solid #4CAF50;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .summary-value {
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }

        .participants {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .participant-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .participant-tag {
            background: #2196F3;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9em;
        }

        .calendar-section {
            margin-top: 30px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .legend {
            display: flex;
            gap: 20px;
            font-size: 0.9em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .legend-available { background: #4CAF50; }
        .legend-busy { background: #f44336; }
        .legend-partial-busy { background: linear-gradient(45deg, #4CAF50 50%, #f44336 50%); }
        .legend-selected { background: #2196F3; }

        .calendar-container {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            background: white;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            background: white;
        }

        #timeGrid {
            display: contents;
        }

        .day-header {
            background: #f5f5f5;
            padding: 15px 10px;
            text-align: center;
            border-right: 1px solid #e0e0e0;
            font-weight: bold;
            color: #333;
        }

        .day-header.today {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .time-label {
            background: #f9f9f9;
            padding: 10px;
            text-align: center;
            border-right: 1px solid #e0e0e0;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9em;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .time-slot {
            border-right: 1px solid #e0e0e0;
            border-bottom: 1px solid #e0e0e0;
            height: 40px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .time-slot.available {
            background: #e8f5e8;
            border: 2px solid #4CAF50;
        }

        .time-slot.available:hover {
            background: #c8e6c9;
            transform: scale(1.02);
            z-index: 2;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .time-slot.busy {
            background: #ffebee;
            border: 2px solid #f44336;
            cursor: not-allowed;
        }

        .time-slot.selected {
            background: #e3f2fd;
            border: 2px solid #2196F3;
            animation: pulse 1s infinite;
        }

        .time-slot.not-in-range {
            background: #fafafa;
            border: 1px solid #e0e0e0;
            cursor: not-allowed;
        }

        .time-slot.partial-busy {
            background: linear-gradient(45deg, #e8f5e8 50%, #ffebee 50%);
            border: 2px solid #ff9800;
            cursor: pointer;
        }

        .time-slot.fully-busy {
            background: #ffebee;
            border: 2px solid #f44336;
            cursor: not-allowed;
        }

        .event-marker {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            background: #f44336;
            border-radius: 50%;
            font-size: 6px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(33, 150, 243, 0); }
            100% { box-shadow: 0 0 0 0 rgba(33, 150, 243, 0); }
        }

        .slot-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.85em;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 10;
            max-width: 300px;
            white-space: normal;
            text-align: left;
        }

        .slot-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #333;
        }

        .time-slot:hover .slot-tooltip {
            opacity: 1;
        }

        .tooltip-section {
            margin-bottom: 8px;
        }

        .tooltip-section:last-child {
            margin-bottom: 0;
        }

        .tooltip-title {
            font-weight: bold;
            margin-bottom: 4px;
            color: #fff;
        }

        .tooltip-event {
            margin-bottom: 3px;
            font-size: 0.8em;
            color: #e0e0e0;
        }

        .schedule-details-panel {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .schedule-details-header {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .member-schedule {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #2196F3;
        }

        .member-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .member-events {
            margin-left: 10px;
        }

        .event-item {
            margin-bottom: 5px;
            padding: 4px 8px;
            background: #f0f8ff;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .event-time {
            font-weight: bold;
            color: #1976d2;
        }

        .event-title {
            color: #666;
            margin-left: 8px;
        }

        .selected-time-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
            border-left: 5px solid #2196F3;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            border: 2px solid #ddd;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .navigation {
            margin-bottom: 20px;
        }

        .nav-link {
            color: #4CAF50;
            text-decoration: none;
            font-weight: bold;
        }

        .nav-link:hover {
            text-decoration: underline;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .no-results-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 20px;
            }

            .calendar-grid {
                grid-template-columns: 60px repeat(7, 1fr);
            }

            .day-header {
                padding: 10px 5px;
                font-size: 0.8em;
            }

            .time-label {
                padding: 5px;
                font-size: 0.7em;
            }

            .time-slot {
                height: 30px;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .legend {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="navigation">
            <a href="/groups/{{ group.id }}/schedule" class="nav-link">â† æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´</a>
        </div>

        <div class="header">
            <h1>ğŸ“… ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç©ºãæ™‚é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>
        </div>

        <!-- æ¤œç´¢æ¡ä»¶ã‚µãƒãƒªãƒ¼ -->
        <div class="search-summary">
            <h3>ğŸ” æ¤œç´¢æ¡ä»¶</h3>
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-label">æ¤œç´¢æœŸé–“</div>
                    <div class="summary-value">{{ search_params.start_date }} ã€œ {{ search_params.end_date }}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">æ™‚é–“å¸¯</div>
                    <div class="summary-value">{{ search_params.start_time }} ã€œ {{ search_params.end_time }}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ™‚é–“</div>
                    <div class="summary-value">{{ search_params.duration }}åˆ†</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">å‚åŠ è€…æ•°</div>
                    <div class="summary-value">{{ search_params.selected_members|length }}å</div>
                </div>
            </div>

            <div class="participants">
                <strong>ğŸ‘¥ å‚åŠ è€…:</strong>
                <div class="participant-tags">
                    {% for member in search_params.selected_members %}
                    <span class="participant-tag">{{ member }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="calendar-section">
            <div class="calendar-header">
                <h3>â° 1é€±é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼</h3>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color legend-available"></div>
                        <span>å…¨å“¡ç©ºã</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-partial-busy"></div>
                        <span>ä¸€éƒ¨äºˆå®šã‚ã‚Š</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-busy"></div>
                        <span>å…¨å“¡äºˆå®šã‚ã‚Š</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-selected"></div>
                        <span>é¸æŠä¸­</span>
                    </div>
                </div>
            </div>

            <div class="calendar-container">
                <div class="calendar-grid" id="calendarGrid">
                    <!-- ç©ºã®ã‚³ãƒ¼ãƒŠãƒ¼ã‚»ãƒ« -->
                    <div class="day-header"></div>
                    
                    <!-- æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                    {% set week_days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'] %}
                    {% for day in week_days %}
                    <div class="day-header" id="day-{{ loop.index0 }}">{{ day }}</div>
                    {% endfor %}
                    
                    <!-- ã‚¿ã‚¤ãƒ ã‚°ãƒªãƒƒãƒ‰ -->
                    <div id="timeGrid"></div>
                </div>
            </div>

            <!-- é¸æŠã•ã‚ŒãŸæ™‚é–“ã®æƒ…å ± -->
            <div class="selected-time-info" id="selectedTimeInfo">
                <h4>ğŸ“‹ é¸æŠã•ã‚ŒãŸæ™‚é–“</h4>
                <p id="selectedTimeText"></p>
                <p>ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ™‚é–“: {{ search_params.duration }}åˆ†</p>
            </div>
            
            <!-- äºˆå®šè©³ç´°è¡¨ç¤ºãƒ‘ãƒãƒ« -->
            <div class="schedule-details-panel" id="scheduleDetailsPanel">
                <div class="schedule-details-header">ğŸ“… ãƒ¡ãƒ³ãƒãƒ¼ã®äºˆå®šè©³ç´°</div>
                <div id="scheduleDetailsContent"></div>
            </div>
            
            <!-- çµæœãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div class="no-results" id="noResultsMessage" style="display: none;">
                <div class="no-results-icon">ğŸ˜”</div>
                <h3>ç©ºãæ™‚é–“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</h3>
                <p>æŒ‡å®šã•ã‚ŒãŸæ¡ä»¶ã§ã¯ã€å…¨å“¡ãŒå‚åŠ å¯èƒ½ãªæ™‚é–“ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
            </div>
        </div>

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
        <div class="action-buttons">
            <a href="/groups/{{ group.id }}/schedule" class="btn btn-secondary">ğŸ”„ æ–°ã—ã„æ¤œç´¢</a>
            <a href="/groups/{{ group.id }}" class="btn btn-primary">ğŸ“‹ ã‚°ãƒ«ãƒ¼ãƒ—ã«æˆ»ã‚‹</a>
            <button class="btn btn-secondary" onclick="hideScheduleDetails()" id="hideDetailsBtn" style="display: none;">ğŸ“… äºˆå®šè©³ç´°ã‚’éè¡¨ç¤º</button>
        </div>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ã‚’éš ã—è¦ç´ ã«ä¿å­˜ -->
    <script type="application/json" id="available-slots-data">{{ available_slots | tojson | safe }}</script>
    <script type="application/json" id="search-params-data">{{ search_params | tojson | safe }}</script>
    <script type="application/json" id="member-schedules-data">{{ member_schedules | tojson | safe }}</script>

    <script>
        // ãƒ‡ãƒ¼ã‚¿ã‚’éš ã—è¦ç´ ã‹ã‚‰å–å¾—
        const availableSlots = JSON.parse(document.getElementById('available-slots-data').textContent);
        const searchParams = JSON.parse(document.getElementById('search-params-data').textContent);
        const memberSchedules = JSON.parse(document.getElementById('member-schedules-data').textContent);
        
        // ãƒ‡ãƒãƒƒã‚°ç”¨ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
        let debugCounter = 0;
        
        // æ™‚é–“ç¯„å›²ã‚’è§£æï¼ˆ24æ™‚é–“å¯¾å¿œï¼‰
        const [startHour, startMinute] = searchParams.start_time.split(':').map(Number);
        const [endHour, endMinute] = searchParams.end_time.split(':').map(Number);
        
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
        console.log('ğŸ” æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:', searchParams);
        console.log('ğŸ“… åˆ©ç”¨å¯èƒ½ã‚¹ãƒ­ãƒƒãƒˆæ•°:', availableSlots.length);
        console.log('ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«:', memberSchedules);
        console.log('â° æ™‚é–“ç¯„å›²:', `${searchParams.start_time} - ${searchParams.end_time}`);
        
        // æ¤œç´¢æœŸé–“ã®é–‹å§‹æ—¥ã‚’åŸºæº–ã«é€±ã®é–‹å§‹æ—¥ã‚’è¨ˆç®—ï¼ˆæœˆæ›œæ—¥ï¼‰
        const searchStartDate = new Date(searchParams.start_date);
        const dayOfWeek = searchStartDate.getDay();
        const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        const monday = new Date(searchStartDate);
        monday.setDate(searchStartDate.getDate() + mondayOffset);
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ã‚’ç”Ÿæˆ
        function generateCalendarGrid() {
            const timeGrid = document.getElementById('timeGrid');
            timeGrid.innerHTML = '';
            
            console.log('ğŸ—ï¸ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆé–‹å§‹');
            console.log(`ğŸ“Š æ™‚é–“ç¯„å›²: ${startHour}:${startMinute.toString().padStart(2,'0')} - ${endHour}:${endMinute.toString().padStart(2,'0')}`);
            
            // é–‹å§‹æ™‚åˆ»ã¨çµ‚äº†æ™‚åˆ»ã‚’åˆ†å˜ä½ã§è¨ˆç®—
            const startTotalMinutes = startHour * 60 + startMinute;
            const endTotalMinutes = endHour * 60 + endMinute;
            
            // 30åˆ†åˆ»ã¿ã®æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã‚’ç”Ÿæˆ
            for (let totalMinutes = startTotalMinutes; totalMinutes < endTotalMinutes; totalMinutes += 30) {
                const hour = Math.floor(totalMinutes / 60);
                const minute = totalMinutes % 60;
                
                const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                
                // æ™‚é–“ãƒ©ãƒ™ãƒ«
                const timeLabel = document.createElement('div');
                timeLabel.className = 'time-label';
                timeLabel.textContent = timeString;
                timeGrid.appendChild(timeLabel);
                
                // å„æ›œæ—¥ã®ã‚¿ã‚¤ãƒ ã‚¹ãƒ­ãƒƒãƒˆ
                for (let day = 0; day < 7; day++) {
                    const currentDate = new Date(monday);
                    currentDate.setDate(monday.getDate() + day);
                    const dateString = currentDate.toISOString().split('T')[0];
                    
                    const slot = document.createElement('div');
                    slot.className = 'time-slot';
                    slot.dataset.date = dateString;
                    slot.dataset.time = timeString;
                    
                    // ã“ã®æ™‚é–“å¸¯ã®ãƒ¡ãƒ³ãƒãƒ¼ã®äºˆå®šçŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
                    const slotStatus = checkSlotStatus(dateString, timeString, searchParams.duration);
                    
                    // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ä½œæˆ
                    const tooltip = document.createElement('div');
                    tooltip.className = 'slot-tooltip';
                    
                    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®åˆ¤å®šã‚’å®Œå…¨ã«ä¿¡é ¼
                    if (slotStatus.isAvailable) {
                        slot.classList.add('available');
                        slot.addEventListener('click', () => selectTimeSlot(slot, dateString, timeString, slotStatus));
                        tooltip.innerHTML = createTooltipContent(timeString, searchParams.duration, slotStatus, 'åˆ©ç”¨å¯èƒ½');
                    } else {
                        // åˆ©ç”¨ã§ããªã„ç†ç”±ã‚’è©³ç´°ã«è¡¨ç¤º
                        if (slotStatus.busyMembers.length === 0) {
                            // äºˆå®šãŒãªã„ã®ã«åˆ©ç”¨ä¸å¯ = æ™‚é–“ç¯„å›²å¤–
                            slot.classList.add('not-in-range');
                            tooltip.innerHTML = createTooltipContent(timeString, searchParams.duration, slotStatus, 'æ¤œç´¢ç¯„å›²å¤–');
                        } else if (slotStatus.busyMembers.length < slotStatus.totalMembers) {
                            // ä¸€éƒ¨ã«äºˆå®šã‚ã‚Š
                            slot.classList.add('partial-busy');
                            const uncredentialed = searchParams.selected_members.length - slotStatus.membersWithCredentials.length;
                            let status = `${slotStatus.busyMembers.length}åäºˆå®šã‚ã‚Š`;
                            if (uncredentialed > 0) {
                                status += `, ${uncredentialed}åæœªèªè¨¼`;
                            }
                            tooltip.innerHTML = createTooltipContent(timeString, searchParams.duration, slotStatus, status);
                        } else {
                            // èªè¨¼æ¸ˆã¿å…¨å“¡ã«äºˆå®šã‚ã‚Š
                            slot.classList.add('fully-busy');
                            tooltip.innerHTML = createTooltipContent(timeString, searchParams.duration, slotStatus, 'èªè¨¼æ¸ˆã¿å…¨å“¡äºˆå®šã‚ã‚Š');
                        }
                    }
                    
                    // äºˆå®šãŒã‚ã‚‹å ´åˆã€ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
                    if (slotStatus.busyMembers.length > 0) {
                        const marker = document.createElement('div');
                        marker.className = 'event-marker';
                        marker.textContent = slotStatus.busyMembers.length;
                        slot.appendChild(marker);
                    }
                    
                    slot.appendChild(tooltip);
                    
                    timeGrid.appendChild(slot);
                }
            }
            
            console.log('âœ… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆå®Œäº†');
            console.log(`ğŸ“… è¡¨ç¤ºé€±ç¯„å›²: ${monday.toISOString().split('T')[0]} ã€œ ${new Date(monday.getTime() + 6 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}`);
            
            // ä»Šæ—¥ã®åˆ—ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            highlightToday();
        }
        
        // ä»Šæ—¥ã®åˆ—ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        function highlightToday() {
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            
            // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹é€±ã«ä»Šæ—¥ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const weekEnd = new Date(monday.getTime() + 6 * 24 * 60 * 60 * 1000);
            const weekEndString = weekEnd.toISOString().split('T')[0];
            const mondayString = monday.toISOString().split('T')[0];
            
            if (todayString >= mondayString && todayString <= weekEndString) {
                const todayDayOfWeek = today.getDay();
                const mondayBasedDay = todayDayOfWeek === 0 ? 6 : todayDayOfWeek - 1;
                
                const todayHeader = document.getElementById(`day-${mondayBasedDay}`);
                if (todayHeader) {
                    todayHeader.classList.add('today');
                    todayHeader.textContent += ` (ä»Šæ—¥)`;
                }
                console.log(`âœ… ä»Šæ—¥(${todayString})ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã—ã¾ã—ãŸ`);
            } else {
                console.log(`â„¹ï¸ ä»Šæ—¥(${todayString})ã¯è¡¨ç¤ºé€±ç¯„å›²å¤–ã§ã™`);
            }
        }
        
        // æ™‚é–“ã«åˆ†ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
        function addMinutes(timeString, minutes) {
            const [hour, minute] = timeString.split(':').map(Number);
            const totalMinutes = hour * 60 + minute + minutes;
            const newHour = Math.floor(totalMinutes / 60);
            const newMinute = totalMinutes % 60;
            return `${newHour.toString().padStart(2, '0')}:${newMinute.toString().padStart(2, '0')}`;
        }
        
        // æŒ‡å®šæ™‚é–“å¸¯ã®äºˆå®šçŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
        function checkSlotStatus(date, startTime, durationMinutes) {
            const [startHour, startMinute] = startTime.split(':').map(Number);
            const slotStart = new Date(`${date}T${startTime}:00`);
            const slotEnd = new Date(slotStart.getTime() + durationMinutes * 60000);
            
            const busyMembers = [];
            const busyEvents = [];
            const membersWithCredentials = [];
            
            // èªè¨¼æƒ…å ±ãŒã‚ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ã‚’ç‰¹å®š
            for (const email of searchParams.selected_members) {
                if (memberSchedules[email] && memberSchedules[email].length >= 0) {
                    membersWithCredentials.push(email);
                }
            }
            
            console.log(`ğŸ” æ™‚é–“å¸¯ ${date} ${startTime}: èªè¨¼æ¸ˆã¿ãƒ¡ãƒ³ãƒãƒ¼ ${membersWithCredentials.length}å / ç·ãƒ¡ãƒ³ãƒãƒ¼ ${searchParams.selected_members.length}å`);
            
            // èªè¨¼æƒ…å ±ãŒã‚ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ã®äºˆå®šã‚’ãƒã‚§ãƒƒã‚¯
            for (const email of membersWithCredentials) {
                for (const event of memberSchedules[email]) {
                    const eventStart = new Date(event.start_datetime);
                    const eventEnd = new Date(event.end_datetime);
                    
                    // æ™‚é–“ãŒé‡è¤‡ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    if (eventStart < slotEnd && eventEnd > slotStart) {
                        if (!busyMembers.includes(email)) {
                            busyMembers.push(email);
                        }
                        busyEvents.push({
                            member: email,
                            title: event.title,
                            start: event.start_time,
                            end: event.end_time
                        });
                    }
                }
            }
            
            // åˆ©ç”¨å¯èƒ½ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®åˆ¤å®šã‚’ä¿¡é ¼ï¼‰
            const isAvailable = availableSlots.some(s => {
                const match = s.date === date && s.start_time === startTime;
                if (match) {
                    console.log(`âœ… ãƒãƒƒãƒãƒ³ã‚°æˆåŠŸ: ${date} ${startTime} -> ã‚¹ãƒ­ãƒƒãƒˆ:`, s);
                }
                return match;
            });
            
            // æœ€åˆã®æ•°å›ã¯ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›
            if (debugCounter < 5) {
                console.log(`ğŸ” åˆ¤å®š ${date} ${startTime}:`, {
                    availableSlots: availableSlots.filter(s => s.date === date).slice(0, 3),
                    isAvailable: isAvailable
                });
                debugCounter++;
            }
            
            // èªè¨¼æƒ…å ±ãŒãªã„ãƒ¡ãƒ³ãƒãƒ¼ã¯ç©ºãã¨ã—ã¦æ‰±ã†ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
            const effectiveTotalMembers = membersWithCredentials.length > 0 ? membersWithCredentials.length : searchParams.selected_members.length;
            
            console.log(`ğŸ“Š ${date} ${startTime}: äºˆå®šã‚ã‚Š${busyMembers.length}å / èªè¨¼æ¸ˆã¿${effectiveTotalMembers}å, åˆ©ç”¨å¯èƒ½: ${isAvailable}`);
            
            return {
                isAvailable: isAvailable,
                busyMembers: busyMembers,
                busyEvents: busyEvents,
                totalMembers: effectiveTotalMembers,
                membersWithCredentials: membersWithCredentials
            };
        }
        
        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—å†…å®¹ã‚’ä½œæˆ
        function createTooltipContent(startTime, durationMinutes, slotStatus, statusText) {
            const endTime = addMinutes(startTime, durationMinutes);
            let content = `<div class="tooltip-section">
                <div class="tooltip-title">${startTime} - ${endTime}</div>
                <div style="color: #ccc;">${statusText}</div>
            </div>`;
            
            if (slotStatus.busyEvents && slotStatus.busyEvents.length > 0) {
                content += `<div class="tooltip-section">
                    <div class="tooltip-title">äºˆå®šã‚ã‚Š:</div>`;
                
                slotStatus.busyEvents.forEach(event => {
                    content += `<div class="tooltip-event">
                        ${event.member}: ${event.title} (${event.start}-${event.end})
                    </div>`;
                });
                
                content += `</div>`;
            }
            
            return content;
        }
        

        
        // æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆé¸æŠ
        function selectTimeSlot(slot, date, time, slotStatus) {
            // ä»–ã®é¸æŠã‚’è§£é™¤
            document.querySelectorAll('.time-slot.selected').forEach(s => {
                s.classList.remove('selected');
            });
            
            // é¸æŠã•ã‚ŒãŸã‚¹ãƒ­ãƒƒãƒˆã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            slot.classList.add('selected');
            
            // é¸æŠæƒ…å ±ã‚’è¡¨ç¤º
            const selectedInfo = document.getElementById('selectedTimeInfo');
            const selectedText = document.getElementById('selectedTimeText');
            
            const dateObj = new Date(date);
            const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const dayName = dayNames[dateObj.getDay()];
            
            selectedText.textContent = `${dateObj.getFullYear()}å¹´${(dateObj.getMonth() + 1)}æœˆ${dateObj.getDate()}æ—¥ (${dayName}) ${time} - ${addMinutes(time, searchParams.duration)}`;
            selectedInfo.style.display = 'block';
            
            // äºˆå®šè©³ç´°ã‚’è¡¨ç¤º
            showScheduleDetails(date, time, slotStatus);
            
            // ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            selectedInfo.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // äºˆå®šè©³ç´°ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
        function showScheduleDetails(date, time, slotStatus) {
            const panel = document.getElementById('scheduleDetailsPanel');
            const content = document.getElementById('scheduleDetailsContent');
            
            let html = '';
            
            for (const email of searchParams.selected_members) {
                const memberEvents = [];
                
                // ãã®ãƒ¡ãƒ³ãƒãƒ¼ã®äºˆå®šã‚’æ¤œç´¢
                if (memberSchedules[email]) {
                    const [startHour, startMinute] = time.split(':').map(Number);
                    const slotStart = new Date(`${date}T${time}:00`);
                    const slotEnd = new Date(slotStart.getTime() + searchParams.duration * 60000);
                    
                    for (const event of memberSchedules[email]) {
                        const eventStart = new Date(event.start_datetime);
                        const eventEnd = new Date(event.end_datetime);
                        
                        // æ™‚é–“ãŒé‡è¤‡ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        if (eventStart < slotEnd && eventEnd > slotStart) {
                            memberEvents.push(event);
                        }
                    }
                }
                
                html += `<div class="member-schedule">
                    <div class="member-name">ğŸ‘¤ ${email}</div>
                    <div class="member-events">`;
                
                if (memberEvents.length > 0) {
                    memberEvents.forEach(event => {
                        html += `<div class="event-item">
                            <span class="event-time">${event.start_time} - ${event.end_time}</span>
                            <span class="event-title">${event.title}</span>
                        </div>`;
                    });
                } else {
                    html += `<div class="event-item" style="background: #e8f5e8; color: #2e7d32;">
                        ğŸ“… ã“ã®æ™‚é–“ã¯ç©ºã„ã¦ã„ã¾ã™
                    </div>`;
                }
                
                html += `</div></div>`;
            }
            
            content.innerHTML = html;
            panel.style.display = 'block';
            
            // éè¡¨ç¤ºãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('hideDetailsBtn').style.display = 'inline-block';
        }
        
        // äºˆå®šè©³ç´°ãƒ‘ãƒãƒ«ã‚’éè¡¨ç¤º
        function hideScheduleDetails() {
            const panel = document.getElementById('scheduleDetailsPanel');
            panel.style.display = 'none';
            
            // é¸æŠã•ã‚ŒãŸã‚¹ãƒ­ãƒƒãƒˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚‚è§£é™¤
            document.querySelectorAll('.time-slot.selected').forEach(s => {
                s.classList.remove('selected');
            });
            
            // é¸æŠã•ã‚ŒãŸæ™‚é–“æƒ…å ±ã‚‚éè¡¨ç¤º
            const selectedInfo = document.getElementById('selectedTimeInfo');
            selectedInfo.style.display = 'none';
            
            // éè¡¨ç¤ºãƒœã‚¿ãƒ³ã‚‚éš ã™
            document.getElementById('hideDetailsBtn').style.display = 'none';
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ç”Ÿæˆ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            console.log('ğŸ“Š åˆ©ç”¨å¯èƒ½ã‚¹ãƒ­ãƒƒãƒˆ:', availableSlots);
            console.log('ğŸ“Š åˆ©ç”¨å¯èƒ½ã‚¹ãƒ­ãƒƒãƒˆæ•°:', availableSlots.length);
            console.log('ğŸ“… æ¤œç´¢æœŸé–“:', `${searchParams.start_date} ã€œ ${searchParams.end_date}`);
            
            // çµæœè¡¨ç¤ºã®åˆ¶å¾¡
            const noResultsMessage = document.getElementById('noResultsMessage');
            const selectedTimeInfo = document.getElementById('selectedTimeInfo');
            
            if (availableSlots.length === 0) {
                noResultsMessage.style.display = 'block';
                selectedTimeInfo.style.display = 'none';
                console.log('âš ï¸ åˆ©ç”¨å¯èƒ½ã‚¹ãƒ­ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“');
            } else {
                noResultsMessage.style.display = 'none';
                selectedTimeInfo.style.display = 'none'; // é¸æŠæ™‚ã«è¡¨ç¤º
                console.log(`ğŸ¯ ${availableSlots.length}ä»¶ã®åˆ©ç”¨å¯èƒ½ã‚¹ãƒ­ãƒƒãƒˆã‚’ç™ºè¦‹`);
            }
            
            try {
                console.log('ğŸ¯ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆã‚’é–‹å§‹');
                generateCalendarGrid();
            } catch (error) {
                console.error('âŒ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
            }
        });
    </script>
</body>
</html> 